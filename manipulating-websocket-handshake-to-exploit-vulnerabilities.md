# Lab: Manipulating the WebSocket handshake to exploit vulnerabilities

**Lab Difficulty:** Practitioner  
**Category:** WebSockets / Cross-Site Scripting (XSS)

## ğŸ” Lab Description

This lab uses a WebSocket-based live chat feature with an aggressive but flawed XSS filter. The server implements IP-based blocking to prevent abuse. The goal is to send a malicious WebSocket message that causes an `alert(1)` popup in the support agent's browser, bypassing the filtering mechanism.

---

## Objective

Trigger an `alert(1)` popup in the support agentâ€™s browser using a WebSocket message.


## Steps to Reproduce

1. **Initiate Chat**
   - Click on "Live Chat" and send any message.
   - This establishes a WebSocket connection.

2. **Intercept in Burp Suite**
   - Go to Burp > Proxy > WebSockets tab.
   - Find the message and right-click > "Send to Repeater".

3. **Attempt Initial XSS Payload**
   - Send a basic XSS payload like:
     ```html
     <img src=x onerror=alert(1)>
     ```
   - Youâ€™ll notice the connection is terminated and your IP gets banned.

4. **Reconnect Attempt**
   - Click â€œReconnectâ€.
   - Youâ€™ll see the reconnection fails due to the IP ban.

5. **Bypass IP Ban**
   - Modify the WebSocket handshake request in Burp Repeater.
   - Add the following header to spoof your IP:
     ```
     X-Forwarded-For: 1.1.1.1
     ```

6. **Reconnect Successfully**
   - With the spoofed header, click â€œConnectâ€ and re-establish the WebSocket connection.

7. **Send Obfuscated XSS Payload**
   - Send an obfuscated XSS payload like:
     ```html
     <img src=x oNeRrOr=alert(1)>
     ```

8. **Lab Solved**


##  Key Takeaways

- **WebSocket handshakes can be manipulated** just like HTTP requests.
- **IP-based blocking** mechanisms can be bypassed by spoofing headers like `X-Forwarded-For`.
- **Obfuscated XSS payloads** can evade naive input filters.


##  Mitigation

- Donâ€™t trust IP addresses from headers like `X-Forwarded-For` unless securely handled by a trusted proxy.
- Sanitize and validate all user inputs before rendering, especially in chat systems.
- Consider implementing WebSocket authentication and rate-limiting.


## ğŸ“š References

- [WebSockets and Security - PortSwigger](https://portswigger.net/web-security/websockets)
- [X-Forwarded-For Header - OWASP](https://owasp.org/www-community/Attacks/Spoofing_IP_Address)
